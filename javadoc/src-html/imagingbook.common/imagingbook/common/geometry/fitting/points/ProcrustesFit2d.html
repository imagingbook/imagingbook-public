<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: module: imagingbook.common, package: imagingbook.common.geometry.fitting.points, class: ProcrustesFit2d">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*******************************************************************************</span>
<span class="source-line-no">002</span><span id="line-2"> * This software is provided as a supplement to the authors' textbooks on digital</span>
<span class="source-line-no">003</span><span id="line-3"> * image processing published by Springer-Verlag in various languages and editions.</span>
<span class="source-line-no">004</span><span id="line-4"> * Permission to use and distribute this software is granted under the BSD 2-Clause</span>
<span class="source-line-no">005</span><span id="line-5"> * "Simplified" License (see http://opensource.org/licenses/BSD-2-Clause).</span>
<span class="source-line-no">006</span><span id="line-6"> * Copyright (c) 2006-2022 Wilhelm Burger, Mark J. Burge. All rights reserved.</span>
<span class="source-line-no">007</span><span id="line-7"> * Visit https://imagingbook.com for additional details.</span>
<span class="source-line-no">008</span><span id="line-8"> ******************************************************************************/</span>
<span class="source-line-no">009</span><span id="line-9">package imagingbook.common.geometry.fitting.points;</span>
<span class="source-line-no">010</span><span id="line-10"></span>
<span class="source-line-no">011</span><span id="line-11">import static imagingbook.common.math.Arithmetic.sqr;</span>
<span class="source-line-no">012</span><span id="line-12"></span>
<span class="source-line-no">013</span><span id="line-13">import org.apache.commons.math3.linear.ArrayRealVector;</span>
<span class="source-line-no">014</span><span id="line-14">import org.apache.commons.math3.linear.LUDecomposition;</span>
<span class="source-line-no">015</span><span id="line-15">import org.apache.commons.math3.linear.MatrixUtils;</span>
<span class="source-line-no">016</span><span id="line-16">import org.apache.commons.math3.linear.RealMatrix;</span>
<span class="source-line-no">017</span><span id="line-17">import org.apache.commons.math3.linear.RealVector;</span>
<span class="source-line-no">018</span><span id="line-18">import org.apache.commons.math3.linear.SingularValueDecomposition;</span>
<span class="source-line-no">019</span><span id="line-19"></span>
<span class="source-line-no">020</span><span id="line-20">import imagingbook.common.geometry.basic.Pnt2d;</span>
<span class="source-line-no">021</span><span id="line-21">import imagingbook.common.geometry.basic.Pnt2d.PntDouble;</span>
<span class="source-line-no">022</span><span id="line-22">import imagingbook.common.geometry.basic.Pnt2d.PntInt;</span>
<span class="source-line-no">023</span><span id="line-23">import imagingbook.common.math.Matrix;</span>
<span class="source-line-no">024</span><span id="line-24">import imagingbook.common.math.PrintPrecision;</span>
<span class="source-line-no">025</span><span id="line-25"></span>
<span class="source-line-no">026</span><span id="line-26"></span>
<span class="source-line-no">027</span><span id="line-27">/**</span>
<span class="source-line-no">028</span><span id="line-28"> * &lt;p&gt;</span>
<span class="source-line-no">029</span><span id="line-29"> * Implements a 2-dimensional Procrustes fit, using the algorithm described in</span>
<span class="source-line-no">030</span><span id="line-30"> * [1]. Usage example:</span>
<span class="source-line-no">031</span><span id="line-31"> * &lt;/p&gt;</span>
<span class="source-line-no">032</span><span id="line-32"> * &lt;pre&gt;</span>
<span class="source-line-no">033</span><span id="line-33"> * Point[] P = ... // create sequence of 2D source points</span>
<span class="source-line-no">034</span><span id="line-34"> * Point[] Q = ... // create sequence of 2D target points</span>
<span class="source-line-no">035</span><span id="line-35"> * ProcrustesFit pf = new ProcrustesFit(P, Q);</span>
<span class="source-line-no">036</span><span id="line-36"> * </span>
<span class="source-line-no">037</span><span id="line-37"> * RealMatrix R = pf.getRotation();</span>
<span class="source-line-no">038</span><span id="line-38"> * RealVector t = pf.getTranslation();</span>
<span class="source-line-no">039</span><span id="line-39"> * double s = pf.getScale();</span>
<span class="source-line-no">040</span><span id="line-40"> * double err = pf.getError();</span>
<span class="source-line-no">041</span><span id="line-41"> * RealMatrix A = pf.getTransformationMatrix();</span>
<span class="source-line-no">042</span><span id="line-42"> * &lt;/pre&gt;</span>
<span class="source-line-no">043</span><span id="line-43"> * &lt;p&gt;</span>
<span class="source-line-no">044</span><span id="line-44"> * [1] Shinji Umeyama, "Least-squares estimation of transformation parameters</span>
<span class="source-line-no">045</span><span id="line-45"> * between two point patterns", IEEE Transactions on Pattern Analysis and</span>
<span class="source-line-no">046</span><span id="line-46"> * Machine Intelligence, 13.4 (Apr. 1991), pp. 376â€“380.</span>
<span class="source-line-no">047</span><span id="line-47"> * &lt;/p&gt;</span>
<span class="source-line-no">048</span><span id="line-48"> * </span>
<span class="source-line-no">049</span><span id="line-49"> * @author WB</span>
<span class="source-line-no">050</span><span id="line-50"> * @version 2021/11/27</span>
<span class="source-line-no">051</span><span id="line-51"> */</span>
<span class="source-line-no">052</span><span id="line-52">public class ProcrustesFit2d implements LinearFit2d {</span>
<span class="source-line-no">053</span><span id="line-53">        </span>
<span class="source-line-no">054</span><span id="line-54">        private final RealMatrix R;                                     // orthogonal (rotation) matrix</span>
<span class="source-line-no">055</span><span id="line-55">        private final RealVector t;                                     // translation vector</span>
<span class="source-line-no">056</span><span id="line-56">        private final double s;                                         // uniform scale</span>
<span class="source-line-no">057</span><span id="line-57">        </span>
<span class="source-line-no">058</span><span id="line-58">        private final RealMatrix A;                                     // resulting transformation matrix</span>
<span class="source-line-no">059</span><span id="line-59">        private final double err;                                       // RMS fitting error</span>
<span class="source-line-no">060</span><span id="line-60">        </span>
<span class="source-line-no">061</span><span id="line-61">        // --------------------------------------------------------------</span>
<span class="source-line-no">062</span><span id="line-62">        </span>
<span class="source-line-no">063</span><span id="line-63">        /**</span>
<span class="source-line-no">064</span><span id="line-64">         * Convenience constructor, with</span>
<span class="source-line-no">065</span><span id="line-65">         * parameters {@code allowTranslation}, {@code allowScaling} and {@code forceRotation}</span>
<span class="source-line-no">066</span><span id="line-66">         * set to {@code true}.</span>
<span class="source-line-no">067</span><span id="line-67">         * @param P the source points</span>
<span class="source-line-no">068</span><span id="line-68">         * @param Q the target points</span>
<span class="source-line-no">069</span><span id="line-69">         */</span>
<span class="source-line-no">070</span><span id="line-70">        public ProcrustesFit2d(Pnt2d[] P, Pnt2d[] Q) {</span>
<span class="source-line-no">071</span><span id="line-71">                this(P, Q, true, true, true);</span>
<span class="source-line-no">072</span><span id="line-72">        }</span>
<span class="source-line-no">073</span><span id="line-73">        </span>
<span class="source-line-no">074</span><span id="line-74">        /**</span>
<span class="source-line-no">075</span><span id="line-75">         * Full constructor.</span>
<span class="source-line-no">076</span><span id="line-76">         * @param P the first point sequence</span>
<span class="source-line-no">077</span><span id="line-77">         * @param Q the second point sequence</span>
<span class="source-line-no">078</span><span id="line-78">         * @param allowTranslation if {@code true}, translation (t) between point sets is considered, </span>
<span class="source-line-no">079</span><span id="line-79">         *              otherwise zero translation is assumed</span>
<span class="source-line-no">080</span><span id="line-80">         * @param allowScaling if {@code true}, scaling (s) between point sets is considered, </span>
<span class="source-line-no">081</span><span id="line-81">         *              otherwise unit scale assumed</span>
<span class="source-line-no">082</span><span id="line-82">         * @param forceRotation if {@code true}, the orthogonal part of the transformation (Q)</span>
<span class="source-line-no">083</span><span id="line-83">         *              is forced to a true rotation and no reflection is allowed</span>
<span class="source-line-no">084</span><span id="line-84">         */</span>
<span class="source-line-no">085</span><span id="line-85">        public ProcrustesFit2d(Pnt2d[] P, Pnt2d[] Q, boolean allowTranslation, boolean allowScaling, boolean forceRotation) {</span>
<span class="source-line-no">086</span><span id="line-86">                checkSize(P, Q);</span>
<span class="source-line-no">087</span><span id="line-87">                </span>
<span class="source-line-no">088</span><span id="line-88">                double[] meanP = null;</span>
<span class="source-line-no">089</span><span id="line-89">                double[] meanY = null;</span>
<span class="source-line-no">090</span><span id="line-90">                </span>
<span class="source-line-no">091</span><span id="line-91">                if (allowTranslation) {</span>
<span class="source-line-no">092</span><span id="line-92">                        meanP = getMeanVec(P);</span>
<span class="source-line-no">093</span><span id="line-93">                        meanY = getMeanVec(Q);</span>
<span class="source-line-no">094</span><span id="line-94">                }</span>
<span class="source-line-no">095</span><span id="line-95">                </span>
<span class="source-line-no">096</span><span id="line-96">                RealMatrix vP = makeDataMatrix(P, meanP);</span>
<span class="source-line-no">097</span><span id="line-97">                RealMatrix vQ = makeDataMatrix(Q, meanY);</span>
<span class="source-line-no">098</span><span id="line-98">                MatrixUtils.checkAdditionCompatible(vP, vQ);    // P, Q of same dimensions?</span>
<span class="source-line-no">099</span><span id="line-99">                </span>
<span class="source-line-no">100</span><span id="line-100">                RealMatrix QPt = vQ.multiply(vP.transpose());</span>
<span class="source-line-no">101</span><span id="line-101">                SingularValueDecomposition svd = new SingularValueDecomposition(QPt);</span>
<span class="source-line-no">102</span><span id="line-102">                </span>
<span class="source-line-no">103</span><span id="line-103">                RealMatrix U = svd.getU();</span>
<span class="source-line-no">104</span><span id="line-104">                RealMatrix S = svd.getS();</span>
<span class="source-line-no">105</span><span id="line-105">                RealMatrix V = svd.getV();</span>
<span class="source-line-no">106</span><span id="line-106">                        </span>
<span class="source-line-no">107</span><span id="line-107">                double d = (svd.getRank() &gt;= 2) ? det(QPt) : det(U) * det(V);</span>
<span class="source-line-no">108</span><span id="line-108">                </span>
<span class="source-line-no">109</span><span id="line-109">                RealMatrix D = MatrixUtils.createRealIdentityMatrix(2);</span>
<span class="source-line-no">110</span><span id="line-110">                if (d &lt; 0 &amp;&amp; forceRotation)</span>
<span class="source-line-no">111</span><span id="line-111">                        D.setEntry(1, 1, -1);</span>
<span class="source-line-no">112</span><span id="line-112">                </span>
<span class="source-line-no">113</span><span id="line-113">                R = U.multiply(D).multiply(V.transpose());</span>
<span class="source-line-no">114</span><span id="line-114">                </span>
<span class="source-line-no">115</span><span id="line-115">                double normP = vP.getFrobeniusNorm();</span>
<span class="source-line-no">116</span><span id="line-116">                double normQ = vQ.getFrobeniusNorm();</span>
<span class="source-line-no">117</span><span id="line-117">                </span>
<span class="source-line-no">118</span><span id="line-118">                s = (allowScaling) ? </span>
<span class="source-line-no">119</span><span id="line-119">                                S.multiply(D).getTrace() / sqr(normP) : 1.0;</span>
<span class="source-line-no">120</span><span id="line-120">                </span>
<span class="source-line-no">121</span><span id="line-121">                if (allowTranslation) {</span>
<span class="source-line-no">122</span><span id="line-122">                        RealVector ma = MatrixUtils.createRealVector(meanP);</span>
<span class="source-line-no">123</span><span id="line-123">                        RealVector mb = MatrixUtils.createRealVector(meanY);</span>
<span class="source-line-no">124</span><span id="line-124">                        t = mb.subtract(R.scalarMultiply(s).operate(ma));</span>
<span class="source-line-no">125</span><span id="line-125">                }</span>
<span class="source-line-no">126</span><span id="line-126">                else {</span>
<span class="source-line-no">127</span><span id="line-127">                        t = new ArrayRealVector(2);     // zero vector</span>
<span class="source-line-no">128</span><span id="line-128">                }</span>
<span class="source-line-no">129</span><span id="line-129">                </span>
<span class="source-line-no">130</span><span id="line-130">                // make the transformation matrix A</span>
<span class="source-line-no">131</span><span id="line-131">                RealMatrix cR = R.scalarMultiply(s);</span>
<span class="source-line-no">132</span><span id="line-132">                A = MatrixUtils.createRealMatrix(2, 3);</span>
<span class="source-line-no">133</span><span id="line-133">                A.setSubMatrix(cR.getData(), 0, 0);</span>
<span class="source-line-no">134</span><span id="line-134">                A.setColumnVector(2, t);</span>
<span class="source-line-no">135</span><span id="line-135">                </span>
<span class="source-line-no">136</span><span id="line-136">                // calculate the fitting error:</span>
<span class="source-line-no">137</span><span id="line-137">                err = Math.sqrt(sqr(normQ) - sqr(S.multiply(D).getTrace() / normP));    </span>
<span class="source-line-no">138</span><span id="line-138">        }</span>
<span class="source-line-no">139</span><span id="line-139">        </span>
<span class="source-line-no">140</span><span id="line-140">        // -----------------------------------------------------------------</span>
<span class="source-line-no">141</span><span id="line-141">        </span>
<span class="source-line-no">142</span><span id="line-142">        /**</span>
<span class="source-line-no">143</span><span id="line-143">         * Retrieves the estimated scale.</span>
<span class="source-line-no">144</span><span id="line-144">         * @return The estimated scale (or 1 if {@code allowscaling = false}).</span>
<span class="source-line-no">145</span><span id="line-145">         */</span>
<span class="source-line-no">146</span><span id="line-146">        public double getScale() {</span>
<span class="source-line-no">147</span><span id="line-147">                return s;</span>
<span class="source-line-no">148</span><span id="line-148">        }</span>
<span class="source-line-no">149</span><span id="line-149">        </span>
<span class="source-line-no">150</span><span id="line-150">        /**</span>
<span class="source-line-no">151</span><span id="line-151">         * Retrieves the estimated orthogonal (rotation) matrix.</span>
<span class="source-line-no">152</span><span id="line-152">         * @return The estimated rotation matrix.</span>
<span class="source-line-no">153</span><span id="line-153">         */</span>
<span class="source-line-no">154</span><span id="line-154">        public double[][] getRotation() {</span>
<span class="source-line-no">155</span><span id="line-155">                return R.getData();</span>
<span class="source-line-no">156</span><span id="line-156">        }</span>
<span class="source-line-no">157</span><span id="line-157">        </span>
<span class="source-line-no">158</span><span id="line-158">        /**</span>
<span class="source-line-no">159</span><span id="line-159">         * Retrieves the estimated translation vector.</span>
<span class="source-line-no">160</span><span id="line-160">         * @return The estimated translation vector.</span>
<span class="source-line-no">161</span><span id="line-161">         */</span>
<span class="source-line-no">162</span><span id="line-162">        public double[] getTranslation() {</span>
<span class="source-line-no">163</span><span id="line-163">                return t.toArray();</span>
<span class="source-line-no">164</span><span id="line-164">        }</span>
<span class="source-line-no">165</span><span id="line-165">        </span>
<span class="source-line-no">166</span><span id="line-166">        // --------------------------------------------------------</span>
<span class="source-line-no">167</span><span id="line-167">        </span>
<span class="source-line-no">168</span><span id="line-168">        @Override</span>
<span class="source-line-no">169</span><span id="line-169">        public double[][] getTransformationMatrix() {</span>
<span class="source-line-no">170</span><span id="line-170">                return A.getData();</span>
<span class="source-line-no">171</span><span id="line-171">//              return A;</span>
<span class="source-line-no">172</span><span id="line-172">        }</span>
<span class="source-line-no">173</span><span id="line-173">        </span>
<span class="source-line-no">174</span><span id="line-174">        @Override</span>
<span class="source-line-no">175</span><span id="line-175">        public double getError() {</span>
<span class="source-line-no">176</span><span id="line-176">                return err;</span>
<span class="source-line-no">177</span><span id="line-177">        }</span>
<span class="source-line-no">178</span><span id="line-178">        </span>
<span class="source-line-no">179</span><span id="line-179">        /**</span>
<span class="source-line-no">180</span><span id="line-180">         * Calculates the total error for the estimated fit as</span>
<span class="source-line-no">181</span><span id="line-181">         * the sum of the squared Euclidean distances between the </span>
<span class="source-line-no">182</span><span id="line-182">         * transformed point set X and the reference set Y.</span>
<span class="source-line-no">183</span><span id="line-183">         * This method is provided for testing as an alternative to</span>
<span class="source-line-no">184</span><span id="line-184">         * the quicker {@link getError} method.</span>
<span class="source-line-no">185</span><span id="line-185">         * </span>
<span class="source-line-no">186</span><span id="line-186">         * @param P Sequence of n-dimensional points.</span>
<span class="source-line-no">187</span><span id="line-187">         * @param Q Sequence of n-dimensional points (reference).</span>
<span class="source-line-no">188</span><span id="line-188">         * @return The total error for the estimated fit.</span>
<span class="source-line-no">189</span><span id="line-189">         */</span>
<span class="source-line-no">190</span><span id="line-190">        private double getEuclideanError(Pnt2d[] P, Pnt2d[] Q) {</span>
<span class="source-line-no">191</span><span id="line-191">                int m = Math.min(P.length,  Q.length);</span>
<span class="source-line-no">192</span><span id="line-192">                RealMatrix sR = R.scalarMultiply(s);</span>
<span class="source-line-no">193</span><span id="line-193">                double errSum = 0;</span>
<span class="source-line-no">194</span><span id="line-194">                for (int i = 0; i &lt; m; i++) {</span>
<span class="source-line-no">195</span><span id="line-195">                        RealVector p = new ArrayRealVector(P[i].toDoubleArray());</span>
<span class="source-line-no">196</span><span id="line-196">                        RealVector q = new ArrayRealVector(Q[i].toDoubleArray());</span>
<span class="source-line-no">197</span><span id="line-197">                        RealVector pp = sR.operate(p).add(t);</span>
<span class="source-line-no">198</span><span id="line-198">                        //System.out.format("p=%s, q=%s, pp=%s\n", p.toString(), q.toString(), pp.toString());</span>
<span class="source-line-no">199</span><span id="line-199">                        double e = pp.subtract(q).getNorm();</span>
<span class="source-line-no">200</span><span id="line-200">                        errSum = errSum + sqr(e);</span>
<span class="source-line-no">201</span><span id="line-201">                }</span>
<span class="source-line-no">202</span><span id="line-202">                return Math.sqrt(errSum);       // correct!</span>
<span class="source-line-no">203</span><span id="line-203">        }</span>
<span class="source-line-no">204</span><span id="line-204">        </span>
<span class="source-line-no">205</span><span id="line-205">        // -----------------------------------------------------------------</span>
<span class="source-line-no">206</span><span id="line-206">        </span>
<span class="source-line-no">207</span><span id="line-207">        private double det(RealMatrix M) {</span>
<span class="source-line-no">208</span><span id="line-208">                return new LUDecomposition(M).getDeterminant();</span>
<span class="source-line-no">209</span><span id="line-209">        }</span>
<span class="source-line-no">210</span><span id="line-210">        </span>
<span class="source-line-no">211</span><span id="line-211">        private double[] getMeanVec(Pnt2d[] points) {</span>
<span class="source-line-no">212</span><span id="line-212">                double sumX = 0;</span>
<span class="source-line-no">213</span><span id="line-213">                double sumY = 0;</span>
<span class="source-line-no">214</span><span id="line-214">                for (Pnt2d p : points) {</span>
<span class="source-line-no">215</span><span id="line-215">                        sumX = sumX + p.getX();</span>
<span class="source-line-no">216</span><span id="line-216">                        sumY = sumY + p.getY();</span>
<span class="source-line-no">217</span><span id="line-217">                }</span>
<span class="source-line-no">218</span><span id="line-218">                return new double[] {sumX / points.length, sumY / points.length};</span>
<span class="source-line-no">219</span><span id="line-219">        }</span>
<span class="source-line-no">220</span><span id="line-220">        </span>
<span class="source-line-no">221</span><span id="line-221">        private RealMatrix makeDataMatrix(Pnt2d[] points, double[] meanX) {</span>
<span class="source-line-no">222</span><span id="line-222">                RealMatrix M = MatrixUtils.createRealMatrix(2, points.length);</span>
<span class="source-line-no">223</span><span id="line-223">                RealVector mean = MatrixUtils.createRealVector(meanX);</span>
<span class="source-line-no">224</span><span id="line-224">                int i = 0;</span>
<span class="source-line-no">225</span><span id="line-225">                for (Pnt2d p : points) {</span>
<span class="source-line-no">226</span><span id="line-226">                        RealVector cv = p.toRealVector();</span>
<span class="source-line-no">227</span><span id="line-227">//                      RealVector cv = MatrixUtils.createRealVector(p.toDoubleArray());</span>
<span class="source-line-no">228</span><span id="line-228">                        if (meanX != null) {</span>
<span class="source-line-no">229</span><span id="line-229">                                cv = cv.subtract(mean);</span>
<span class="source-line-no">230</span><span id="line-230">                        }</span>
<span class="source-line-no">231</span><span id="line-231">                        M.setColumnVector(i, cv);</span>
<span class="source-line-no">232</span><span id="line-232">                        i++;</span>
<span class="source-line-no">233</span><span id="line-233">                }</span>
<span class="source-line-no">234</span><span id="line-234">                return M;</span>
<span class="source-line-no">235</span><span id="line-235">        }</span>
<span class="source-line-no">236</span><span id="line-236">        </span>
<span class="source-line-no">237</span><span id="line-237">//      private void printSVD(SingularValueDecomposition svd) {</span>
<span class="source-line-no">238</span><span id="line-238">//              RealMatrix U = svd.getU();</span>
<span class="source-line-no">239</span><span id="line-239">//              RealMatrix S = svd.getS();</span>
<span class="source-line-no">240</span><span id="line-240">//              RealMatrix V = svd.getV();</span>
<span class="source-line-no">241</span><span id="line-241">//              System.out.println("------ SVD ---------------");</span>
<span class="source-line-no">242</span><span id="line-242">//              System.out.println("U = " + Matrix.toString(U.getData()));</span>
<span class="source-line-no">243</span><span id="line-243">//              System.out.println("S = " + Matrix.toString(S.getData()));</span>
<span class="source-line-no">244</span><span id="line-244">//              System.out.println("V = " + Matrix.toString(V.getData()));</span>
<span class="source-line-no">245</span><span id="line-245">//              System.out.println("--------------------------");</span>
<span class="source-line-no">246</span><span id="line-246">//      }</span>
<span class="source-line-no">247</span><span id="line-247">        </span>
<span class="source-line-no">248</span><span id="line-248">        </span>
<span class="source-line-no">249</span><span id="line-249">        private void checkSize(Pnt2d[] P, Pnt2d[] Q) {</span>
<span class="source-line-no">250</span><span id="line-250">                if (P.length &lt; 3 || Q.length &lt; 3) {</span>
<span class="source-line-no">251</span><span id="line-251">                        throw new IllegalArgumentException("At least 3 point pairs are required to calculate this fit");</span>
<span class="source-line-no">252</span><span id="line-252">                }</span>
<span class="source-line-no">253</span><span id="line-253">        }</span>
<span class="source-line-no">254</span><span id="line-254"></span>
<span class="source-line-no">255</span><span id="line-255">        </span>
<span class="source-line-no">256</span><span id="line-256">        </span>
<span class="source-line-no">257</span><span id="line-257">        private static double roundToDigits(double x, int ndigits) {</span>
<span class="source-line-no">258</span><span id="line-258">                int d = (int) Math.pow(10, ndigits);</span>
<span class="source-line-no">259</span><span id="line-259">                return Math.rint(x * d) / d;</span>
<span class="source-line-no">260</span><span id="line-260">        }</span>
<span class="source-line-no">261</span><span id="line-261"></span>
<span class="source-line-no">262</span><span id="line-262">        // --------------------------------------------------------------------------------</span>
<span class="source-line-no">263</span><span id="line-263">        </span>
<span class="source-line-no">264</span><span id="line-264">        public static void main(String[] args) {</span>
<span class="source-line-no">265</span><span id="line-265">                PrintPrecision.set(6);</span>
<span class="source-line-no">266</span><span id="line-266">                int NDIGITS = 1;</span>
<span class="source-line-no">267</span><span id="line-267">                </span>
<span class="source-line-no">268</span><span id="line-268">                boolean allowTranslation = true;</span>
<span class="source-line-no">269</span><span id="line-269">                boolean allowScaling = true;</span>
<span class="source-line-no">270</span><span id="line-270">                boolean forceRotation = true;</span>
<span class="source-line-no">271</span><span id="line-271">                </span>
<span class="source-line-no">272</span><span id="line-272">                double a = 0.6;</span>
<span class="source-line-no">273</span><span id="line-273">                double[][] R0data =</span>
<span class="source-line-no">274</span><span id="line-274">                        {{ Math.cos(a), -Math.sin(a) },</span>
<span class="source-line-no">275</span><span id="line-275">                         { Math.sin(a),  Math.cos(a) }};</span>
<span class="source-line-no">276</span><span id="line-276">                </span>
<span class="source-line-no">277</span><span id="line-277">                RealMatrix R0 = MatrixUtils.createRealMatrix(R0data);</span>
<span class="source-line-no">278</span><span id="line-278">                double[] t0 = {4, -3};</span>
<span class="source-line-no">279</span><span id="line-279">                double s = 3.5;</span>
<span class="source-line-no">280</span><span id="line-280">                </span>
<span class="source-line-no">281</span><span id="line-281">                System.out.format("original alpha: a = %.6f\n", a);</span>
<span class="source-line-no">282</span><span id="line-282">                System.out.println("original rotation: R = \n" + Matrix.toString(R0.getData()));</span>
<span class="source-line-no">283</span><span id="line-283">                System.out.println("original translation: t = " + Matrix.toString(t0));</span>
<span class="source-line-no">284</span><span id="line-284">                System.out.format("original scale: s = %.6f\n", s);</span>
<span class="source-line-no">285</span><span id="line-285">                System.out.println();</span>
<span class="source-line-no">286</span><span id="line-286">                </span>
<span class="source-line-no">287</span><span id="line-287">                Pnt2d[] P = {</span>
<span class="source-line-no">288</span><span id="line-288">                                PntInt.from(2, 5),</span>
<span class="source-line-no">289</span><span id="line-289">                                PntInt.from(7, 3),</span>
<span class="source-line-no">290</span><span id="line-290">                                PntInt.from(0, 9),</span>
<span class="source-line-no">291</span><span id="line-291">                                PntInt.from(5, 4)</span>
<span class="source-line-no">292</span><span id="line-292">                };</span>
<span class="source-line-no">293</span><span id="line-293">                </span>
<span class="source-line-no">294</span><span id="line-294">                Pnt2d[] Q = new Pnt2d[P.length];</span>
<span class="source-line-no">295</span><span id="line-295">                </span>
<span class="source-line-no">296</span><span id="line-296">                for (int i = 0; i &lt; P.length; i++) {</span>
<span class="source-line-no">297</span><span id="line-297">                        Pnt2d q = PntDouble.from(R0.operate(P[i].toDoubleArray()));</span>
<span class="source-line-no">298</span><span id="line-298">                        // noise!</span>
<span class="source-line-no">299</span><span id="line-299">                        double qx = roundToDigits(s * q.getX() + t0[0], NDIGITS);</span>
<span class="source-line-no">300</span><span id="line-300">                        double qy = roundToDigits(s * q.getY() + t0[1], NDIGITS);</span>
<span class="source-line-no">301</span><span id="line-301">                        Q[i] = Pnt2d.PntDouble.from(qx, qy);</span>
<span class="source-line-no">302</span><span id="line-302">                }</span>
<span class="source-line-no">303</span><span id="line-303">                </span>
<span class="source-line-no">304</span><span id="line-304">                //P[0] = Point.create(2, 0);    // to provoke a large error</span>
<span class="source-line-no">305</span><span id="line-305">                </span>
<span class="source-line-no">306</span><span id="line-306">                ProcrustesFit2d pf = new ProcrustesFit2d(P, Q, allowTranslation, allowScaling, forceRotation);</span>
<span class="source-line-no">307</span><span id="line-307"></span>
<span class="source-line-no">308</span><span id="line-308">                double[][] R = pf.getRotation();</span>
<span class="source-line-no">309</span><span id="line-309">                System.out.format("estimated alpha: a = %.6f\n", Math.acos(R[0][0]));</span>
<span class="source-line-no">310</span><span id="line-310">                System.out.println("estimated rotation: R = \n" + Matrix.toString(R));</span>
<span class="source-line-no">311</span><span id="line-311">                double[] T = pf.getTranslation();</span>
<span class="source-line-no">312</span><span id="line-312">                System.out.println("estimated translation: t = " + Matrix.toString(T));</span>
<span class="source-line-no">313</span><span id="line-313">                System.out.format("estimated scale: s = %.6f\n", pf.getScale());</span>
<span class="source-line-no">314</span><span id="line-314">                </span>
<span class="source-line-no">315</span><span id="line-315">                System.out.println();</span>
<span class="source-line-no">316</span><span id="line-316">                System.out.format("RMS fitting error = %.6f\n", pf.getError());</span>
<span class="source-line-no">317</span><span id="line-317">                System.out.format("euclidean error (test) = %.6f\n", pf.getEuclideanError(P, Q));</span>
<span class="source-line-no">318</span><span id="line-318">                </span>
<span class="source-line-no">319</span><span id="line-319">                double[][] A = pf.getTransformationMatrix();</span>
<span class="source-line-no">320</span><span id="line-320">                System.out.println("transformation matrix: A = \n" + Matrix.toString(A));</span>
<span class="source-line-no">321</span><span id="line-321">        }</span>
<span class="source-line-no">322</span><span id="line-322"></span>
<span class="source-line-no">323</span><span id="line-323">        /*</span>
<span class="source-line-no">324</span><span id="line-324">        original alpha: a = 0.600000</span>
<span class="source-line-no">325</span><span id="line-325">        original rotation: R = </span>
<span class="source-line-no">326</span><span id="line-326">        {{0.825336, -0.564642}, </span>
<span class="source-line-no">327</span><span id="line-327">        {0.564642, 0.825336}}</span>
<span class="source-line-no">328</span><span id="line-328">        original translation: t = {4.000000, -3.000000}</span>
<span class="source-line-no">329</span><span id="line-329">        original scale: s = 3.500000</span>
<span class="source-line-no">330</span><span id="line-330">        </span>
<span class="source-line-no">331</span><span id="line-331">        estimated alpha: a = 0.599589</span>
<span class="source-line-no">332</span><span id="line-332">        estimated rotation: R = </span>
<span class="source-line-no">333</span><span id="line-333">        {{0.825568, -0.564303}, </span>
<span class="source-line-no">334</span><span id="line-334">        {0.564303, 0.825568}}</span>
<span class="source-line-no">335</span><span id="line-335">        estimated translation: t = {3.980905, -3.011055}</span>
<span class="source-line-no">336</span><span id="line-336">        estimated scale: s = 3.500560</span>
<span class="source-line-no">337</span><span id="line-337">        </span>
<span class="source-line-no">338</span><span id="line-338">        fitting error = 0.048079</span>
<span class="source-line-no">339</span><span id="line-339">        euclidean error (test) = 0.048079</span>
<span class="source-line-no">340</span><span id="line-340">        transformation matrix: A = </span>
<span class="source-line-no">341</span><span id="line-341">        {{2.889950, -1.975377, 3.980905}, </span>
<span class="source-line-no">342</span><span id="line-342">        {1.975377, 2.889950, -3.011055}}</span>
<span class="source-line-no">343</span><span id="line-343">         */</span>
<span class="source-line-no">344</span><span id="line-344">}</span>
<span class="source-line-no">345</span><span id="line-345"></span>




























































</pre>
</div>
</main>
</body>
</html>
