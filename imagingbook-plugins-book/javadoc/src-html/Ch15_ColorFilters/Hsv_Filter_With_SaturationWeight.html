<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc -->
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
</head>
<body>
<main role="main">
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a id="line.1">/*******************************************************************************</a>
<span class="sourceLineNo">002</span><a id="line.2"> * This software is provided as a supplement to the authors' textbooks on digital</a>
<span class="sourceLineNo">003</span><a id="line.3"> * image processing published by Springer-Verlag in various languages and editions.</a>
<span class="sourceLineNo">004</span><a id="line.4"> * Permission to use and distribute this software is granted under the BSD 2-Clause </a>
<span class="sourceLineNo">005</span><a id="line.5"> * "Simplified" License (see http://opensource.org/licenses/BSD-2-Clause). </a>
<span class="sourceLineNo">006</span><a id="line.6"> * Copyright (c) 2006-2022 Wilhelm Burger, Mark J. Burge. </a>
<span class="sourceLineNo">007</span><a id="line.7"> * All rights reserved. Visit https://imagingbook.com for additional details.</a>
<span class="sourceLineNo">008</span><a id="line.8"> *******************************************************************************/</a>
<span class="sourceLineNo">009</span><a id="line.9">package Ch15_ColorFilters;</a>
<span class="sourceLineNo">010</span><a id="line.10"></a>
<span class="sourceLineNo">011</span><a id="line.11"></a>
<span class="sourceLineNo">012</span><a id="line.12">import ij.ImagePlus;</a>
<span class="sourceLineNo">013</span><a id="line.13">import ij.plugin.filter.GaussianBlur;</a>
<span class="sourceLineNo">014</span><a id="line.14">import ij.plugin.filter.PlugInFilter;</a>
<span class="sourceLineNo">015</span><a id="line.15">import ij.process.ColorProcessor;</a>
<span class="sourceLineNo">016</span><a id="line.16">import ij.process.FloatProcessor;</a>
<span class="sourceLineNo">017</span><a id="line.17">import ij.process.ImageProcessor;</a>
<span class="sourceLineNo">018</span><a id="line.18">import imagingbook.common.color.RgbUtils;</a>
<span class="sourceLineNo">019</span><a id="line.19">import imagingbook.common.color.colorspace.HsvColorSpace;</a>
<span class="sourceLineNo">020</span><a id="line.20">import imagingbook.common.math.Arithmetic;</a>
<span class="sourceLineNo">021</span><a id="line.21"></a>
<span class="sourceLineNo">022</span><a id="line.22">/**</a>
<span class="sourceLineNo">023</span><a id="line.23"> * This ImageJ plugin implements a Gaussian blur filter to the periodic</a>
<span class="sourceLineNo">024</span><a id="line.24"> * hue component in HSV space.</a>
<span class="sourceLineNo">025</span><a id="line.25"> * @author WB</a>
<span class="sourceLineNo">026</span><a id="line.26"> *</a>
<span class="sourceLineNo">027</span><a id="line.27"> */</a>
<span class="sourceLineNo">028</span><a id="line.28"></a>
<span class="sourceLineNo">029</span><a id="line.29">public class Hsv_Filter_With_SaturationWeight implements PlugInFilter {</a>
<span class="sourceLineNo">030</span><a id="line.30">        </a>
<span class="sourceLineNo">031</span><a id="line.31">        static double sigma = 3.0;</a>
<span class="sourceLineNo">032</span><a id="line.32">        static boolean FILTER_ALL_COMPONENTS = true;</a>
<span class="sourceLineNo">033</span><a id="line.33">        static boolean SHOW_ORIGINAL_HSV = true;</a>
<span class="sourceLineNo">034</span><a id="line.34"></a>
<span class="sourceLineNo">035</span><a id="line.35">        public int setup(String arg, ImagePlus imp) {</a>
<span class="sourceLineNo">036</span><a id="line.36">                return DOES_RGB;</a>
<span class="sourceLineNo">037</span><a id="line.37">        }</a>
<span class="sourceLineNo">038</span><a id="line.38"></a>
<span class="sourceLineNo">039</span><a id="line.39">        public void run(ImageProcessor ip) {</a>
<span class="sourceLineNo">040</span><a id="line.40">                ColorProcessor cp = (ColorProcessor) ip;</a>
<span class="sourceLineNo">041</span><a id="line.41">                final int w = ip.getWidth();</a>
<span class="sourceLineNo">042</span><a id="line.42">                final int h = ip.getHeight();</a>
<span class="sourceLineNo">043</span><a id="line.43">                </a>
<span class="sourceLineNo">044</span><a id="line.44">                FloatProcessor fH = new FloatProcessor(w, h);</a>
<span class="sourceLineNo">045</span><a id="line.45">                FloatProcessor fS = new FloatProcessor(w, h);</a>
<span class="sourceLineNo">046</span><a id="line.46">                FloatProcessor fV = new FloatProcessor(w, h);</a>
<span class="sourceLineNo">047</span><a id="line.47">                </a>
<span class="sourceLineNo">048</span><a id="line.48">                if (SHOW_ORIGINAL_HSV) {</a>
<span class="sourceLineNo">049</span><a id="line.49">                        new ImagePlus("H", fH).show();</a>
<span class="sourceLineNo">050</span><a id="line.50">                        new ImagePlus("S", fS).show();</a>
<span class="sourceLineNo">051</span><a id="line.51">                        new ImagePlus("V", fV).show();</a>
<span class="sourceLineNo">052</span><a id="line.52">                }</a>
<span class="sourceLineNo">053</span><a id="line.53">                </a>
<span class="sourceLineNo">054</span><a id="line.54">                // Create Cos/Sin images from the hue angle:</a>
<span class="sourceLineNo">055</span><a id="line.55">                HsvColorSpace cc = HsvColorSpace.getInstance();</a>
<span class="sourceLineNo">056</span><a id="line.56">                final int[] RGB = new int[3];</a>
<span class="sourceLineNo">057</span><a id="line.57">                FloatProcessor fHsin = new FloatProcessor(w, h);</a>
<span class="sourceLineNo">058</span><a id="line.58">                FloatProcessor fHcos = new FloatProcessor(w, h);</a>
<span class="sourceLineNo">059</span><a id="line.59">                for (int v = 0; v &lt; h; v++) {</a>
<span class="sourceLineNo">060</span><a id="line.60">                        for (int u = 0; u &lt; w; u++) {</a>
<span class="sourceLineNo">061</span><a id="line.61">                                cp.getPixel(u, v, RGB);</a>
<span class="sourceLineNo">062</span><a id="line.62">                                float[] HSV = cc.fromRGB (RgbUtils.normalize(RGB));     // all HSV components are in [0,1]</a>
<span class="sourceLineNo">063</span><a id="line.63">                                double theta = 2 * Math.PI * HSV[0];</a>
<span class="sourceLineNo">064</span><a id="line.64">                                float s = HSV[1];</a>
<span class="sourceLineNo">065</span><a id="line.65">                                fHsin.setf(u, v, (float) Math.sin(theta) * s);</a>
<span class="sourceLineNo">066</span><a id="line.66">                                fHcos.setf(u, v, (float) Math.cos(theta) * s);</a>
<span class="sourceLineNo">067</span><a id="line.67">                                fH.setf(u, v, HSV[0]);  // hue </a>
<span class="sourceLineNo">068</span><a id="line.68">                                fS.setf(u, v, HSV[1]);  // saturation</a>
<span class="sourceLineNo">069</span><a id="line.69">                                fV.setf(u, v, HSV[2]);  // value</a>
<span class="sourceLineNo">070</span><a id="line.70">                        }</a>
<span class="sourceLineNo">071</span><a id="line.71">                }</a>
<span class="sourceLineNo">072</span><a id="line.72"></a>
<span class="sourceLineNo">073</span><a id="line.73">                new ImagePlus("Hcos", fHcos).show();</a>
<span class="sourceLineNo">074</span><a id="line.74">                new ImagePlus("Hsin", fHsin).show();</a>
<span class="sourceLineNo">075</span><a id="line.75">                </a>
<span class="sourceLineNo">076</span><a id="line.76">//              int[] hist = fH.getHistogram();</a>
<span class="sourceLineNo">077</span><a id="line.77">//              new HistogramPlot(hist, "Hue histogram").show();</a>
<span class="sourceLineNo">078</span><a id="line.78">                </a>
<span class="sourceLineNo">079</span><a id="line.79">                </a>
<span class="sourceLineNo">080</span><a id="line.80">                // Apply the Gaussian filter to Cos/Sin:</a>
<span class="sourceLineNo">081</span><a id="line.81">                GaussianBlur gb = new GaussianBlur();</a>
<span class="sourceLineNo">082</span><a id="line.82">                gb.blurFloat(fHcos, sigma, sigma, 0.002);</a>
<span class="sourceLineNo">083</span><a id="line.83">                gb.blurFloat(fHsin, sigma, sigma, 0.002);</a>
<span class="sourceLineNo">084</span><a id="line.84">                </a>
<span class="sourceLineNo">085</span><a id="line.85">                if (FILTER_ALL_COMPONENTS) {</a>
<span class="sourceLineNo">086</span><a id="line.86">                        gb.blurFloat(fS, sigma, sigma, 0.002);</a>
<span class="sourceLineNo">087</span><a id="line.87">                        gb.blurFloat(fV, sigma, sigma, 0.002);</a>
<span class="sourceLineNo">088</span><a id="line.88">                }</a>
<span class="sourceLineNo">089</span><a id="line.89">                </a>
<span class="sourceLineNo">090</span><a id="line.90">                // Calculate the filtered hue angle from Cos/Sin:</a>
<span class="sourceLineNo">091</span><a id="line.91">                FloatProcessor fHrec = combineCosSin(fHcos, fHsin);</a>
<span class="sourceLineNo">092</span><a id="line.92">                new ImagePlus("Hrec", fHrec).show();</a>
<span class="sourceLineNo">093</span><a id="line.93">                // Reconstruct and show the corresponding RGB image:</a>
<span class="sourceLineNo">094</span><a id="line.94">                ColorProcessor cp2 = makeRgb(fHrec, fS, fV);</a>
<span class="sourceLineNo">095</span><a id="line.95">                new ImagePlus("hue blurred cos/sin", cp2).show();</a>
<span class="sourceLineNo">096</span><a id="line.96">                </a>
<span class="sourceLineNo">097</span><a id="line.97">//              // For testing, also show a direct blur of hue (disregarding periodicity):</a>
<span class="sourceLineNo">098</span><a id="line.98">//              FloatProcessor fHblur = (FloatProcessor) fH.duplicate();</a>
<span class="sourceLineNo">099</span><a id="line.99">//              gb.blurFloat(fHblur, sigma, sigma, 0.002);</a>
<span class="sourceLineNo">100</span><a id="line.100">//              new ImagePlus("Hblur", fHblur).show();</a>
<span class="sourceLineNo">101</span><a id="line.101">//              // Reconstruct and show the corresponding RGB image:</a>
<span class="sourceLineNo">102</span><a id="line.102">//              ColorProcessor cp3 = makeRgb(fHblur, fS, fV);</a>
<span class="sourceLineNo">103</span><a id="line.103">//              new ImagePlus("hue blurred direct", cp3).show();</a>
<span class="sourceLineNo">104</span><a id="line.104">        }</a>
<span class="sourceLineNo">105</span><a id="line.105">        </a>
<span class="sourceLineNo">106</span><a id="line.106">        </a>
<span class="sourceLineNo">107</span><a id="line.107">        FloatProcessor combineCosSin(FloatProcessor fHcos, FloatProcessor fHsin) {</a>
<span class="sourceLineNo">108</span><a id="line.108">                final int w = fHcos.getWidth();</a>
<span class="sourceLineNo">109</span><a id="line.109">                final int h = fHcos.getHeight();</a>
<span class="sourceLineNo">110</span><a id="line.110">                FloatProcessor fHrec = new FloatProcessor(w, h);</a>
<span class="sourceLineNo">111</span><a id="line.111">                final double twoPi = 2 * Math.PI;</a>
<span class="sourceLineNo">112</span><a id="line.112">                </a>
<span class="sourceLineNo">113</span><a id="line.113">                // rebuild the RGB image from blurred cos/sin</a>
<span class="sourceLineNo">114</span><a id="line.114">                for (int v = 0; v &lt; h; v++) {</a>
<span class="sourceLineNo">115</span><a id="line.115">                        for (int u = 0; u &lt; w; u++) {</a>
<span class="sourceLineNo">116</span><a id="line.116">                                double Hcos = fHcos.getf(u, v);</a>
<span class="sourceLineNo">117</span><a id="line.117">                                double Hsin = fHsin.getf(u, v);</a>
<span class="sourceLineNo">118</span><a id="line.118">                                double theta = Math.atan2(Hsin, Hcos);    // Hpp in [-pi, .. pi]</a>
<span class="sourceLineNo">119</span><a id="line.119">                                float H = (float) (Arithmetic.mod(theta, twoPi) / twoPi);  // H in [0, 1]</a>
<span class="sourceLineNo">120</span><a id="line.120">                                fHrec.setf(u, v, H);</a>
<span class="sourceLineNo">121</span><a id="line.121">                        }</a>
<span class="sourceLineNo">122</span><a id="line.122">                }</a>
<span class="sourceLineNo">123</span><a id="line.123">                return fHrec;</a>
<span class="sourceLineNo">124</span><a id="line.124">        }</a>
<span class="sourceLineNo">125</span><a id="line.125">        </a>
<span class="sourceLineNo">126</span><a id="line.126">        /**</a>
<span class="sourceLineNo">127</span><a id="line.127">         * Combine 3 FloatProcessors representing a HSV image to a RGB image.</a>
<span class="sourceLineNo">128</span><a id="line.128">         * @param fH hue component (values in [0,1])</a>
<span class="sourceLineNo">129</span><a id="line.129">         * @param fS saturation component (values in [0,1])</a>
<span class="sourceLineNo">130</span><a id="line.130">         * @param fV value component (values in [0,1])</a>
<span class="sourceLineNo">131</span><a id="line.131">         * @return A new ColorProcessor.</a>
<span class="sourceLineNo">132</span><a id="line.132">         */</a>
<span class="sourceLineNo">133</span><a id="line.133">        ColorProcessor makeRgb(FloatProcessor fH, FloatProcessor fS, FloatProcessor fV) {</a>
<span class="sourceLineNo">134</span><a id="line.134">                final int w = fH.getWidth();</a>
<span class="sourceLineNo">135</span><a id="line.135">                final int h = fH.getHeight();</a>
<span class="sourceLineNo">136</span><a id="line.136">                ColorProcessor cp = new ColorProcessor(w, h);</a>
<span class="sourceLineNo">137</span><a id="line.137">                HsvColorSpace cc = HsvColorSpace.getInstance();</a>
<span class="sourceLineNo">138</span><a id="line.138">                </a>
<span class="sourceLineNo">139</span><a id="line.139">                for (int v = 0; v &lt; h; v++) {</a>
<span class="sourceLineNo">140</span><a id="line.140">                        for (int u = 0; u &lt; w; u++) {</a>
<span class="sourceLineNo">141</span><a id="line.141">                                float H = fH.getf(u, v);</a>
<span class="sourceLineNo">142</span><a id="line.142">                                float S = fS.getf(u, v);</a>
<span class="sourceLineNo">143</span><a id="line.143">                                float V = fV.getf(u, v);</a>
<span class="sourceLineNo">144</span><a id="line.144">                                int[] RGB2 = RgbUtils.unnormalize(cc.toRGB(new float[] {H, S, V}));</a>
<span class="sourceLineNo">145</span><a id="line.145">                                cp.putPixel(u, v, RGB2);</a>
<span class="sourceLineNo">146</span><a id="line.146">                        }</a>
<span class="sourceLineNo">147</span><a id="line.147">                }</a>
<span class="sourceLineNo">148</span><a id="line.148">                return cp;</a>
<span class="sourceLineNo">149</span><a id="line.149">        }</a>
<span class="sourceLineNo">150</span><a id="line.150">}</a>




























































</pre>
</div>
</main>
</body>
</html>
